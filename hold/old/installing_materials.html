<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Installing New Materials &mdash; Material Model Laboratory 2.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Material Model Laboratory 2.0 documentation" href="../../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../../index.html">Material Model Laboratory 2.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="installing-new-materials">
<span id="installing"></span><h1>Installing New Materials<a class="headerlink" href="#installing-new-materials" title="Permalink to this headline">¶</a></h1>
<p><em>Payette</em> was born from the need for an environment in which material models
could be rapidly developed, tested, deployed, and maintained, independent of
host finite element code implementation. Important prerequisites in the design
of <em>Payette</em> were ease of model installation and support for constitutive
routines written in Fortran. This requirement is met by providing a simple API
with which a model developer can install a material in <em>Payette</em> as a new
Python class and use <a class="reference external" href="http://www.scipy.org/F2py">f2py</a> to compile Python
extension modules from the material&#8217;s Fortran source (if applicable). In this
section, the required elements of the constitutive model interface and
instructions on compiling the material&#8217;s Fortran source (if applicable) are
provided.</p>
<div class="section" id="build-process">
<h2>Build Process<a class="headerlink" href="#build-process" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">buildPayette</span></tt> script, described in <a class="reference internal" href="../building.html#installation"><em>Installation</em></a>, scans the
<tt class="docutils literal"><span class="pre">PAYETTE_ROOT/Source/Materials</span></tt> directory for a materials xml control file.
The xml control file contains directives informing <em>Payette</em> the locations of
the following files: the build module and the interface module.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><em>Payette</em> is an open source project, without restrictions on how the source
code is used and/or distributed. However, many material models have
restrictive access controls and cannot, therefore, be included in
<em>Payette</em>. This is the case for many materials currently being developed
with <em>Payette</em>. For these materials, <em>Payette</em> provides two methods for
extending the list of directories it scans for material interface modules:</p>
<ol class="last arabic simple">
<li><tt class="docutils literal"><span class="pre">PAYETTE_MTLDIR</span></tt> environment variable. A colon separated list of
directories containing <em>Payette</em> interface modules.</li>
<li><tt class="docutils literal"><span class="pre">--mtldir</span></tt> <tt class="file docutils literal"><span class="pre">configure.py</span></tt> option. At the configuration step,
directories containing <em>Payette</em> interface modules can be passed to
<em>Payette</em> through the <tt class="docutils literal"><span class="pre">--mtldir=/path/to/material/directory</span></tt> option.</li>
</ol>
</div>
</div>
<div class="section" id="naming-convention">
<h2>Naming Convention<a class="headerlink" href="#naming-convention" title="Permalink to this headline">¶</a></h2>
<p>For default materials included with <em>Payette</em>, the following naming
convention has been adopted for a material &#8220;material model&#8221;:</p>
<dl class="docutils">
<dt>XML control file</dt>
<dd><tt class="file docutils literal"><span class="pre">PAYETTE_ROOT/Materials/Models/MaterialModel/MaterialModel_control.xml</span></tt></dd>
<dt>Interface file</dt>
<dd><tt class="file docutils literal"><span class="pre">PAYETTE_ROOT/Materials/Models/MaterialModel/Payette_material_model.py</span></tt></dd>
<dt>Build script</dt>
<dd><tt class="file docutils literal"><span class="pre">PAYETTE_ROOT/Materials/Models/MaterialModel/Build_material_model.py</span></tt></dd>
<dt>Fortran source</dt>
<dd><tt class="file docutils literal"><span class="pre">PAYETTE_ROOT/Materials/Models/MaterialModel/material_model.f</span></tt></dd>
</dl>
</div>
<div class="section" id="control-file-format">
<h2>Control File Format<a class="headerlink" href="#control-file-format" title="Permalink to this headline">¶</a></h2>
<p>The XML control file must provide the following nodes</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;MaterialModel&gt;
  &lt;Name&gt;ModelName&lt;/Name&gt;

  &lt;Type&gt; Material type [mechanical, eos, electromechanical] &lt;/Type&gt;

  &lt;Description&gt;
    Material model description
  &lt;/Description&gt;

  &lt;Owner&gt;Owner Name (owner@domain.com)&lt;/Owner&gt;

  &lt;Files&gt;
    &lt;Core&gt;
      material_model.f90
    &lt;/Core&gt;
    &lt;Interface type=&quot;payette&quot;&gt;
      Build_material_model.py
      Payette_material_model.py
      Payette_material_model.pyf
    &lt;/Interface&gt;
  &lt;/Files&gt;

  &lt;Distribution&gt;
    distribution level [uur, unlimited]
  &lt;/Distribution&gt;

  &lt;ModelParameters&gt;
    &lt;Key&gt;material_model&lt;/Key&gt;
    &lt;Aliases&gt;material_model_aliases&lt;/Aliases&gt;

    &lt;Units&gt;parameter_units&lt;/Units&gt;

    &lt;Parameter name=&quot;PARAM_0&quot; order=&quot;0&quot;  type=&quot;double&quot; default=&quot;0&quot; units=&quot;UNITS&quot;&gt;
      Description of PARAM_0
    &lt;/Parameter&gt;
        .
        .
        .
    &lt;Parameter name=&quot;PARAM_N&quot; order=&quot;N&quot; type=&quot;double&quot; default=&quot;0&quot; units=&quot;UNITS&quot;&gt;
      Description of PARAM_N
    &lt;/Parameter&gt;

    &lt;Material name=&quot;MATERIAL_NAME&quot; dist=&quot;dist_level&quot; PARAM_0=&quot;value&quot; ... PARAM_N=&quot;value&quot; aliases=&quot;any_aliases&quot;/&gt;

  &lt;/ModelParameters&gt;

&lt;/MaterialModel&gt;
</pre></div>
</div>
</div>
<div class="section" id="material-interface-module">
<h2>Material Interface Module<a class="headerlink" href="#material-interface-module" title="Permalink to this headline">¶</a></h2>
<p>Each material model must provide an interface module used by <em>Payette</em> to
interact with that material. The interface module must provide a material
class derived from the <tt class="docutils literal"><span class="pre">ConstitutiveModelPrototype</span></tt> base class.</p>
<div class="section" id="material-class">
<h3>Material Class<a class="headerlink" href="#material-class" title="Permalink to this headline">¶</a></h3>
<p><em>Payette</em> provides a simple interface for interacting with material models
through the Python class structure. Material models are installed as separate
Python classes, derived from the <tt class="docutils literal"><span class="pre">ConstitutiveModelPrototype</span></tt> base class.</p>
<div class="section" id="inheritance-from-base-class">
<h4>Inheritance From Base Class<a class="headerlink" href="#inheritance-from-base-class" title="Permalink to this headline">¶</a></h4>
<p>A new material model &#8220;material model&#8221; is only recognized as a material model
by Payette if it inherits from the <tt class="docutils literal"><span class="pre">ConstitutiveModelPrototype</span></tt> base class:</p>
<div class="highlight-python"><div class="highlight"><pre>class MaterialModel(ConstitutiveModelPrototype):
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">ConstitutiveModelPrototype</span></tt> base class provides several methods in its
API for material models to communicate with <em>Payette</em>. Minimally, the material
model must provide the following data: <tt class="docutils literal"><span class="pre">aliases</span></tt>, <tt class="docutils literal"><span class="pre">bulk_modulus</span></tt>,
<tt class="docutils literal"><span class="pre">imported</span></tt>, <tt class="docutils literal"><span class="pre">name</span></tt>, <tt class="docutils literal"><span class="pre">nprop</span></tt>, and <tt class="docutils literal"><span class="pre">shear_modulus</span></tt>, and methods:
<tt class="docutils literal"><span class="pre">__init__</span></tt>, <tt class="docutils literal"><span class="pre">set_up</span></tt>, and <tt class="docutils literal"><span class="pre">update_state</span></tt>.</p>
</div>
<div class="section" id="required-data">
<h4>Required Data<a class="headerlink" href="#required-data" title="Permalink to this headline">¶</a></h4>
<dl class="data">
<dt id="MaterialModel.aliases">
<tt class="descclassname">MaterialModel.</tt><tt class="descname">aliases</tt><a class="headerlink" href="#MaterialModel.aliases" title="Permalink to this definition">¶</a></dt>
<dd><p>List. The aliases by which the constitutive model can be called (case
insensitive).</p>
</dd></dl>

<dl class="data">
<dt id="MaterialModel.bulk_modulus">
<tt class="descclassname">MaterialModel.</tt><tt class="descname">bulk_modulus</tt><a class="headerlink" href="#MaterialModel.bulk_modulus" title="Permalink to this definition">¶</a></dt>
<dd><p>Float. The bulk modulus. Used for determining the material&#8217;s Jacobian matrix</p>
</dd></dl>

<dl class="data">
<dt id="MaterialModel.imported">
<tt class="descclassname">MaterialModel.</tt><tt class="descname">imported</tt><a class="headerlink" href="#MaterialModel.imported" title="Permalink to this definition">¶</a></dt>
<dd><p>Boolean. Indicator of whether the material&#8217;s extension library (if
applicable) was imported.</p>
</dd></dl>

<dl class="data">
<dt id="MaterialModel.name">
<tt class="descclassname">MaterialModel.</tt><tt class="descname">name</tt><a class="headerlink" href="#MaterialModel.name" title="Permalink to this definition">¶</a></dt>
<dd><p>String. The name by which users can invoke the constituve model from the
input file (case insensitive).</p>
</dd></dl>

<dl class="data">
<dt id="MaterialModel.nprop">
<tt class="descclassname">MaterialModel.</tt><tt class="descname">nprop</tt><a class="headerlink" href="#MaterialModel.nprop" title="Permalink to this definition">¶</a></dt>
<dd><p>Int. The number of required parameters for the model.</p>
</dd></dl>

<dl class="data">
<dt id="MaterialModel.shear_modulus">
<tt class="descclassname">MaterialModel.</tt><tt class="descname">shear_modulus</tt><a class="headerlink" href="#MaterialModel.shear_modulus" title="Permalink to this definition">¶</a></dt>
<dd><p>Float. The shear modulus. Used for determining the material&#8217;s Jacobian
matrix</p>
</dd></dl>

</div>
</div>
<div class="section" id="required-functions">
<h3>Required Functions<a class="headerlink" href="#required-functions" title="Permalink to this headline">¶</a></h3>
<p><tt class="docutils literal"><span class="pre">__init__(self)</span></tt></p>
<blockquote>
<div><p>Instantiate the material model. Register parameters with <em>Payette</em>.
Parameters are registered by the <tt class="docutils literal"><span class="pre">register_parameter</span></tt> method</p>
<div class="highlight-python"><div class="highlight"><pre>register_parameter(self, name, ui_loc, aliases=[])
    &quot;&quot;&quot;Register the parameter name with Payette.

    ui_loc is the integer location (starting at 0) of the parameter in
    the material&#39;s user input array. aliases are aliases by which the
    parameter can be specified in the input file.&quot;&quot;&quot;
</pre></div>
</div>
<p>Alternatively, the <tt class="docutils literal"><span class="pre">register_parameters_from_control_file()</span></tt> method can
be called and parameters from the control file will be registered
automatically.</p>
</div></blockquote>
<p><tt class="docutils literal"><span class="pre">set_up(self,</span> <span class="pre">simdat,</span> <span class="pre">matdat,</span> <span class="pre">user_params,</span> <span class="pre">f_params)</span></tt></p>
<blockquote>
<div>Check user inputs and register extra variables with <em>Payette</em>. <em>simdat</em> and
<em>matdat</em> are the simulation and material data containers, respectively,
<em>user_params</em> are the parameters read in from the input file, and <em>f_params</em>
are parameters from a parameters file.</div></blockquote>
<p><tt class="docutils literal"><span class="pre">update_state(self,</span> <span class="pre">simdat,</span> <span class="pre">matdat)</span></tt></p>
<blockquote>
<div>Update the material state to the end of the current time step. <em>simdat</em> and
<em>matdat</em> are the simulation and material data containers, respectively.</div></blockquote>
</div>
</div>
<div class="section" id="example-elastic-material-model-interface-file">
<h2>Example: Elastic Material Model Interface File<a class="headerlink" href="#example-elastic-material-model-interface-file" title="Permalink to this headline">¶</a></h2>
<p>The required elements of the material&#8217;s interface file described above are now
demonstrated by an annotated version of the elastic material&#8217;s interface.</p>
<p><strong>View the source code:</strong> <a class="reference download internal" href="../../_downloads/Payette_elastic.py"><tt class="xref download docutils literal"><span class="pre">Payette_elastic.py</span></tt></a></p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">array</span>

<span class="kn">from</span> <span class="nn">Source.Payette_utils</span> <span class="kn">import</span> <span class="n">log_warning</span><span class="p">,</span> <span class="n">log_message</span><span class="p">,</span> <span class="n">report_and_raise_error</span>
<span class="kn">from</span> <span class="nn">Source.Payette_tensor</span> <span class="kn">import</span> <span class="n">iso</span><span class="p">,</span> <span class="n">dev</span>
<span class="kn">from</span> <span class="nn">Source.Payette_constitutive_model</span> <span class="kn">import</span> <span class="n">ConstitutiveModelPrototype</span>
<span class="kn">from</span> <span class="nn">Payette_config</span> <span class="kn">import</span> <span class="n">PC_F2PY_CALLBACK</span>
<span class="kn">from</span> <span class="nn">Toolset.elastic_conversion</span> <span class="kn">import</span> <span class="n">compute_elastic_constants</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">Source.Materials.Library.elastic</span> <span class="kn">as</span> <span class="nn">mtllib</span>
    <span class="n">imported</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">imported</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Elastic</span><span class="p">(</span><span class="n">ConstitutiveModelPrototype</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Elasticity model. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_file</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Elastic</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">control_file</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">imported</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s">&quot;python&quot;</span> <span class="k">else</span> <span class="n">imported</span>

        <span class="c"># register parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_parameters_from_control_file</span><span class="p">()</span>

        <span class="k">pass</span>

    <span class="c"># public methods</span>
    <span class="k">def</span> <span class="nf">set_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matdat</span><span class="p">):</span>

        <span class="c"># parse parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_parameters</span><span class="p">()</span>

        <span class="c"># the elastic model only needs the bulk and shear modulus, but the</span>
        <span class="c"># user could have specified any one of the many elastic moduli.</span>
        <span class="c"># Convert them and get just the bulk and shear modulus</span>
        <span class="n">eui</span> <span class="o">=</span> <span class="n">compute_elastic_constants</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ui0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">12</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">eui</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_table</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_table</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="s">&quot;ui pos&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui0</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="c"># Payette wants ui to be the same length as ui0, but we don&#39;t want to</span>
        <span class="c"># work with the entire ui, so we only pick out what we want</span>
        <span class="n">mu</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui0</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui0</span>
        <span class="n">mui</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">mu</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_modulus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shear_modulus</span> <span class="o">=</span> <span class="n">k</span><span class="p">,</span> <span class="n">mu</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s">&quot;python&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mui</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_py_set_up</span><span class="p">(</span><span class="n">mui</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mui</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fort_set_up</span><span class="p">(</span><span class="n">mui</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simdat</span><span class="p">,</span> <span class="n">matdat</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">matdat</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s">&quot;prescribed stress components&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">J0</span><span class="p">[[[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">],</span><span class="n">v</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">update_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simdat</span><span class="p">,</span> <span class="n">matdat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           update the material state based on current state and strain increment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># get passed arguments</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">simdat</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s">&quot;time step&quot;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">matdat</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s">&quot;rate of deformation&quot;</span><span class="p">)</span>
        <span class="n">sigold</span> <span class="o">=</span> <span class="n">matdat</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s">&quot;stress&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s">&quot;python&quot;</span><span class="p">:</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">_py_update_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mui</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">sigold</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mui</span><span class="p">,</span> <span class="n">sigold</span><span class="p">,</span> <span class="n">d</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">PC_F2PY_CALLBACK</span><span class="p">:</span>
                <span class="n">a</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">report_and_raise_error</span><span class="p">,</span> <span class="n">log_message</span><span class="p">])</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">mtllib</span><span class="o">.</span><span class="n">elast_calc</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>

        <span class="c"># store updated data</span>
        <span class="n">matdat</span><span class="o">.</span><span class="n">store_data</span><span class="p">(</span><span class="s">&quot;stress&quot;</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_py_set_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mui</span><span class="p">):</span>

        <span class="n">k</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="n">mui</span>

        <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">report_and_raise_error</span><span class="p">(</span><span class="s">&quot;Bulk modulus K must be positive&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mu</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">report_and_raise_error</span><span class="p">(</span><span class="s">&quot;Shear modulus MU must be positive&quot;</span><span class="p">)</span>

        <span class="c"># poisson&#39;s ratio</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nu</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">log_warning</span><span class="p">(</span><span class="s">&quot;negative Poisson&#39;s ratio&quot;</span><span class="p">)</span>

        <span class="n">ui</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">mu</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">ui</span>

    <span class="k">def</span> <span class="nf">_fort_set_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mui</span><span class="p">):</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">mui</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">props</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">PC_F2PY_CALLBACK</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">report_and_raise_error</span><span class="p">,</span> <span class="n">log_message</span><span class="p">])</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="n">mtllib</span><span class="o">.</span><span class="n">elast_chk</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ui</span>


<span class="k">def</span> <span class="nf">_py_update_state</span><span class="p">(</span><span class="n">ui</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">sigold</span><span class="p">):</span>

    <span class="c"># strain increment</span>
    <span class="n">de</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">dt</span>

    <span class="c"># user properties</span>
    <span class="n">k</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="n">ui</span>
    <span class="n">twomu</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">mu</span>
    <span class="n">threek</span> <span class="o">=</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">k</span>

    <span class="c"># elastic stress update</span>
    <span class="k">return</span> <span class="n">sigold</span> <span class="o">+</span> <span class="n">threek</span> <span class="o">*</span> <span class="n">iso</span><span class="p">(</span><span class="n">de</span><span class="p">)</span> <span class="o">+</span> <span class="n">twomu</span> <span class="o">*</span> <span class="n">dev</span><span class="p">(</span><span class="n">de</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="building-material-fortran-extension-modules-in-payette">
<h2>Building Material Fortran Extension Modules in <em>Payette</em><a class="headerlink" href="#building-material-fortran-extension-modules-in-payette" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is not an exhaustive tutorial for how to link Python programs with
compiled source code. Instead, it demonstrates through an annotated example
the strategy that <em>Payette</em> uses to build and link with material models
written in Fortran.</p>
</div>
<p>The strategy used in <em>Payette</em> to build and link to material models written in
Fortran is to use <em>f2py</em> to compile the Fortran source in to a shared object
library recognized by Python. The same task can be accomplished through Python&#8217;s
built in <a class="reference external" href="http://docs.python.org/library/ctypes.html">ctypes</a>, <a class="reference external" href="http://www.scipy.org/Weave">weave</a>, or other methods. We have found that <em>f2py</em>
offers the most robust and easy to use solution. For more detailed examples of
how to use compiled libraries with Python see <a class="reference external" href="http://docs.scipy.org/doc/numpy/user/c-info.python-as-glue.html">Using Python as glue</a> at the SciPy
website or <a class="reference external" href="http://www.sagemath.org/doc/numerical_sage/using_compiled_code_iteractively.html">Using Compiled Code Interactively</a>
on Sage&#8217;s website.</p>
<p>Rather than provide an exhaustive tutorial on linking Python programs to compiled
libraries, we demonstrate how the <tt class="docutils literal"><span class="pre">elastic</span></tt> material model accomplishes this
task through annotated examples.</p>
<div class="section" id="creating-the-elastic-material-signature-file">
<h3>Creating the Elastic Material Signature File<a class="headerlink" href="#creating-the-elastic-material-signature-file" title="Permalink to this headline">¶</a></h3>
<p>First, a Python signature file for the <tt class="docutils literal"><span class="pre">elatic</span></tt> material&#8217;s Fortran source must
be created. A signature file is a Fortran 90 file that contains all of the
information that is needed to construct Python bindings to Fortran (or C)
functions.</p>
<p>For the elastic model, change to
<tt class="file docutils literal"><span class="pre">PAYETTE_ROOT/Source/Materials/Fortran</span></tt> and execute</p>
<div class="highlight-python"><div class="highlight"><pre>% f2py -m elastic -h Payette_elastic.pyf elastic.F
</pre></div>
</div>
<p>which will create the <tt class="file docutils literal"><span class="pre">Payette_elastic.pyf</span></tt> signature file.</p>
<p>f2py will create a signature for every function in <tt class="file docutils literal"><span class="pre">elastic.F</span></tt>. However,
only three public functions need to be bound to our Python program. So, after
creating the signature file, all of the signatures for the private functions can
safely be removed.</p>
<p>The signature file can be modified even further. See the above links on how to
specialize your signature file for maximum speed and efficiency.</p>
<p><strong>View the Payette_elastic.pyf file:</strong> <a class="reference download internal" href="../../_downloads/Payette_elastic.pyf"><tt class="xref download docutils literal"><span class="pre">Payette_elastic.pyf</span></tt></a></p>
</div>
<div class="section" id="elastic-material-build-script">
<h3>Elastic Material Build Script<a class="headerlink" href="#elastic-material-build-script" title="Permalink to this headline">¶</a></h3>
<p>Materials are built by <em>f2py</em> through the <tt class="docutils literal"><span class="pre">MaterialBuilder</span></tt> class from which
each material derives its <tt class="docutils literal"><span class="pre">Build</span></tt> class. The <tt class="docutils literal"><span class="pre">Build</span></tt> class must provide a
<tt class="docutils literal"><span class="pre">build_extension_module</span></tt> function, as shown below in the elastic material&#8217;s
build script.</p>
<p><strong>View the elastic material build script:</strong> <a class="reference download internal" href="../../_downloads/Build_elastic.py"><tt class="xref download docutils literal"><span class="pre">Build_elastic.py</span></tt></a></p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">Payette_config</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">Source.Payette_utils</span> <span class="kn">import</span> <span class="n">BuildError</span>
<span class="kn">from</span> <span class="nn">Source.Materials.Payette_build_material</span> <span class="kn">import</span> <span class="n">MaterialBuilder</span>

<span class="k">class</span> <span class="nc">Build</span><span class="p">(</span><span class="n">MaterialBuilder</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">libname</span><span class="p">,</span> <span class="n">compiler_info</span><span class="p">):</span>

        <span class="n">fdir</span><span class="p">,</span><span class="n">fnam</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnam</span> <span class="o">=</span> <span class="n">fdir</span><span class="p">,</span> <span class="n">fnam</span>

        <span class="c"># initialize base class</span>
        <span class="n">srcd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fdir</span><span class="p">,</span> <span class="s">&quot;Fortran&quot;</span><span class="p">)</span>
        <span class="n">sigf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fdir</span><span class="p">,</span> <span class="s">&quot;Payette_elastic.pyf&quot;</span><span class="p">)</span>
        <span class="n">MaterialBuilder</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">libname</span><span class="p">,</span> <span class="n">srcd</span><span class="p">,</span> <span class="n">compiler_info</span><span class="p">,</span> <span class="n">sigf</span><span class="o">=</span><span class="n">sigf</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">build_extension_module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># fortran files</span>
        <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;elastic.F&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_directory</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">srcs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_extension_module_with_f2py</span><span class="p">()</span>

        <span class="k">return</span> <span class="mi">0</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For the elastic material, the <tt class="docutils literal"><span class="pre">build_extension_module</span></tt> function defines the
Fortran source files and the calls the base class&#8217;s
<tt class="docutils literal"><span class="pre">build_extension_module_with_f2py</span></tt> function.</p>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Material Model Laboratory</a></h1>





<p>
<iframe src="http://ghbtns.com/github-btn.html?user=tjfulle&repo=matmodlab&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>


<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../source/background.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/users.html">User&#8217;s Guide</a></li>
</ul>


<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2014, Tim Fuller.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.2.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster </a>
      
      |
      <a href="../../_sources/hold/old/installing_materials.txt"
          rel="nofollow">Page source</a></li>
    </div>

    

    
  </body>
</html>